<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Batch Splitting Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e1e8ed;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .results-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 13px;
        }

        .results-table tr:hover {
            background-color: #f8f9fa;
        }

        .results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .status-success {
            color: #27ae60;
            font-weight: bold;
        }

        .status-warning {
            color: #f39c12;
            font-weight: bold;
        }

        .status-danger {
            color: #e74c3c;
            font-weight: bold;
        }

        .priority-urgent {
            background-color: #ffebee;
            border-left: 4px solid #e74c3c;
        }

        .priority-high {
            background-color: #fff3e0;
            border-left: 4px solid #f39c12;
        }

        .priority-normal {
            background-color: #e8f5e8;
            border-left: 4px solid #27ae60;
        }

        .priority-low {
            background-color: #f5f5f5;
            border-left: 4px solid #95a5a6;
        }

        /* Table row priority colors */
        .results-table tr.priority-urgent {
            background-color: #ffebee !important;
            border-left: 4px solid #e74c3c;
        }

        .results-table tr.priority-urgent:hover {
            background-color: #ffcdd2 !important;
        }

        .results-table tr.priority-high {
            background-color: #fff3e0 !important;
            border-left: 4px solid #f39c12;
        }

        .results-table tr.priority-high:hover {
            background-color: #ffe0b2 !important;
        }

        .results-table tr.priority-normal {
            background-color: #e8f5e8 !important;
            border-left: 4px solid #27ae60;
        }

        .results-table tr.priority-normal:hover {
            background-color: #c8e6c9 !important;
        }

        .results-table tr.priority-low {
            background-color: #f5f5f5 !important;
            border-left: 4px solid #95a5a6;
        }

        .results-table tr.priority-low:hover {
            background-color: #e0e0e0 !important;
        }

        .test-scenario {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .scenario-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .batch-info {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Smart Batch Splitting Test</h1>
            <p>Intelligent Algorithm: Priority + Deadline = Optimal Batch Distribution</p>
        </div>

        <div class="card">
            <h2>üéØ Test Scenarios</h2>
            <div class="test-scenario priority-urgent">
                <div class="scenario-header">üö® Urgent Priority (Q400) - Due Tomorrow</div>
                <div>Part: PN2001 | Qty: 400 | Priority: Urgent | Due: Tomorrow</div>
                <div>Expected: 3 batches (150, 150, 100 pieces) for maximum parallelization</div>
            </div>
            
            <div class="test-scenario priority-high">
                <div class="scenario-header">‚ö° High Priority (Q600) - Due in 3 Days</div>
                <div>Part: PN3001 | Qty: 600 | Priority: High | Due: 3 days</div>
                <div>Expected: 3 batches (210, 210, 180 pieces) for faster completion</div>
            </div>
            
            <div class="test-scenario priority-normal">
                <div class="scenario-header">üìã Normal Priority (Q800) - Due in 1 Week</div>
                <div>Part: PN4001 | Qty: 800 | Priority: Normal | Due: 1 week</div>
                <div>Expected: 3 batches (300, 300, 200 pieces) for standard processing</div>
            </div>
            
            <div class="test-scenario priority-low">
                <div class="scenario-header">üêå Low Priority (Q1000) - Due in 2 Weeks</div>
                <div>Part: PN5001 | Qty: 1000 | Priority: Low | Due: 2 weeks</div>
                <div>Expected: 3 batches (450, 450, 100 pieces) for efficiency</div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Smart Batch Splitting Results</h2>
            <div id="loadingResults" class="loading">
                Loading smart batch splitting results...
            </div>
            <table class="results-table" id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Part Number</th>
                        <th>Order Qty</th>
                        <th>Priority</th>
                        <th>Batch ID</th>
                        <th>Batch Qty</th>
                        <th>Op Seq</th>
                        <th>Operation Name</th>
                        <th>Machine</th>
                        <th>Person</th>
                        <th>Setup Start</th>
                        <th>Setup End</th>
                        <th>Run Start</th>
                        <th>Run End</th>
                        <th>Timing</th>
                        <th>Due Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>üß† Smart Algorithm Analysis</h2>
            <div id="algorithmAnalysis">
                <div class="loading">Analyzing smart batch splitting decisions...</div>
            </div>
        </div>

        <div class="card">
            <h2>üìà Batch Distribution Summary</h2>
            <div id="batchSummary">
                <div class="loading">Calculating batch distribution statistics...</div>
            </div>
        </div>
    </div>

    <!-- Load the scheduling engine -->
    <script src="x10-browser.js?v=2.0"></script>
    
    <script>
        // Test data with different priorities and deadlines
        const testOrders = [
            {
                partNumber: 'PN2001',
                quantity: 400,
                priority: 'Urgent',
                dueDate: '2025-09-02', // Tomorrow
                startDateTime: '2025-09-01 06:00'
            },
            {
                partNumber: 'PN3001',
                quantity: 600,
                priority: 'High',
                dueDate: '2025-09-04', // 3 days
                startDateTime: '2025-09-01 06:00'
            },
            {
                partNumber: 'PN4001',
                quantity: 800,
                priority: 'Normal',
                dueDate: '2025-09-08', // 1 week
                startDateTime: '2025-09-01 06:00'
            },
            {
                partNumber: 'PN5001',
                quantity: 1000,
                priority: 'Low',
                dueDate: '2025-09-15', // 2 weeks
                startDateTime: '2025-09-01 06:00'
            }
        ];

        const testOperations = [
            // PN2001 operations (3 operations)
            {
                PartNumber: 'PN2001',
                OperationSeq: 1,
                OperationName: 'Roughing',
                SetupTime_Min: 60,
                CycleTime_Min: 8,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 1', 'VMC 2', 'VMC 3'],
                Operator: 1
            },
            {
                PartNumber: 'PN2001',
                OperationSeq: 2,
                OperationName: 'Finishing',
                SetupTime_Min: 45,
                CycleTime_Min: 5,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 4', 'VMC 5'],
                Operator: 1
            },
            {
                PartNumber: 'PN2001',
                OperationSeq: 3,
                OperationName: 'Inspection',
                SetupTime_Min: 30,
                CycleTime_Min: 2,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 6', 'VMC 7'],
                Operator: 1
            },
            
            // PN3001 operations (2 operations)
            {
                PartNumber: 'PN3001',
                OperationSeq: 1,
                OperationName: 'Turning',
                SetupTime_Min: 70,
                CycleTime_Min: 12,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 1', 'VMC 2', 'VMC 3', 'VMC 4'],
                Operator: 1
            },
            {
                PartNumber: 'PN3001',
                OperationSeq: 2,
                OperationName: 'Milling',
                SetupTime_Min: 50,
                CycleTime_Min: 8,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 5', 'VMC 6', 'VMC 7'],
                Operator: 1
            },
            
            // PN4001 operations (2 operations)
            {
                PartNumber: 'PN4001',
                OperationSeq: 1,
                OperationName: 'Facing',
                SetupTime_Min: 80,
                CycleTime_Min: 15,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 1', 'VMC 2'],
                Operator: 1
            },
            {
                PartNumber: 'PN4001',
                OperationSeq: 2,
                OperationName: 'Threading',
                SetupTime_Min: 60,
                CycleTime_Min: 10,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 3', 'VMC 4'],
                Operator: 1
            },
            
            // PN5001 operations (1 operation)
            {
                PartNumber: 'PN5001',
                OperationSeq: 1,
                OperationName: 'Simple',
                SetupTime_Min: 100,
                CycleTime_Min: 20,
                Minimum_BatchSize: 1,
                EligibleMachines: ['VMC 1', 'VMC 2', 'VMC 3', 'VMC 4', 'VMC 5', 'VMC 6', 'VMC 7'],
                Operator: 1
            }
        ];

        // Run the test when page loads
        window.addEventListener('load', function() {
            console.log('üß† Starting Smart Batch Splitting Test...');
            
            try {
                const result = runSchedulingInBrowser(testOrders, testOperations);
                
                if (result.success) {
                    console.log('‚úÖ Smart batch splitting test executed successfully');
                    displayResults(result.outputData.mainOutput);
                    analyzeAlgorithm(result.outputData.mainOutput);
                    displayBatchSummary(result.outputData.mainOutput);
                } else {
                    console.log('‚ùå Test failed');
                    document.getElementById('loadingResults').innerHTML = '‚ùå Test failed';
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('loadingResults').innerHTML = '‚ùå Error: ' + error.message;
            }
        });

        function displayResults(results) {
            // Hide loading and show table
            document.getElementById('loadingResults').style.display = 'none';
            document.getElementById('resultsTable').style.display = 'table';
            
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            results.forEach(row => {
                const [partNumber, orderQty, priority, batchId, batchQty, opSeq, opName, machine, person, setupStart, setupEnd, runStart, runEnd, timing, dueDate] = row;
                
                const tr = document.createElement('tr');
                
                // Check if due date is met
                const runEndDate = new Date(runEnd);
                const dueDateObj = new Date(dueDate);
                const isOnTime = runEndDate <= dueDateObj;
                const statusClass = isOnTime ? 'status-success' : 'status-warning';
                const statusText = isOnTime ? '‚úÖ' : '‚ö†Ô∏è';
                
                // Add priority-based row styling
                const priorityClass = `priority-${priority.toLowerCase()}`;
                tr.className = priorityClass;
                
                tr.innerHTML = `
                    <td>${partNumber}</td>
                    <td>${orderQty}</td>
                    <td>${priority}</td>
                    <td>${batchId}</td>
                    <td>${batchQty}</td>
                    <td>${opSeq}</td>
                    <td>${opName}</td>
                    <td>${machine}</td>
                    <td>${person}</td>
                    <td>${setupStart}</td>
                    <td>${setupEnd}</td>
                    <td>${runStart}</td>
                    <td>${runEnd}</td>
                    <td>${timing}</td>
                    <td>${dueDate}</td>
                    <td class="${statusClass}">${statusText}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function analyzeAlgorithm(results) {
            const analysisDiv = document.getElementById('algorithmAnalysis');
            analysisDiv.innerHTML = '';
            
            // Group by part number
            const parts = {};
            results.forEach(row => {
                const partNumber = row[0];
                if (!parts[partNumber]) {
                    parts[partNumber] = [];
                }
                parts[partNumber].push(row);
            });
            
            let analysisHtml = '';
            Object.keys(parts).forEach(partNumber => {
                const operations = parts[partNumber];
                const orderQty = operations[0][1];
                const priority = operations[0][2];
                const dueDate = operations[0][14];
                
                // Count unique batches
                const batches = new Set(operations.map(op => op[3]));
                const numBatches = batches.size;
                const avgBatchSize = Math.round(orderQty / numBatches);
                
                // Calculate days until deadline
                const start = new Date('2025-09-01');
                const due = new Date(dueDate);
                const daysUntilDeadline = Math.ceil((due - start) / (1000 * 60 * 60 * 24));
                
                // Determine algorithm decision
                let algorithmDecision = '';
                if (priority === 'Urgent' || daysUntilDeadline <= 2) {
                    algorithmDecision = `üö® AGGRESSIVE SPLITTING: ${numBatches} batches (${avgBatchSize} pieces each) - Urgent deadline requires maximum parallelization`;
                } else if (priority === 'High') {
                    algorithmDecision = `‚ö° HIGH PRIORITY SPLITTING: ${numBatches} batches (${avgBatchSize} pieces each) - Faster completion through parallel processing`;
                } else if (priority === 'Normal') {
                    algorithmDecision = `üìã STANDARD SPLITTING: ${numBatches} batches (${avgBatchSize} pieces each) - Balanced approach for normal priority`;
                } else if (priority === 'Low') {
                    algorithmDecision = `üêå EFFICIENT SPLITTING: ${numBatches} batches (${avgBatchSize} pieces each) - Larger batches for low priority efficiency`;
                }
                
                analysisHtml += `
                    <div class="batch-info">
                        <strong>${partNumber} (${orderQty} pieces, ${priority} priority):</strong><br>
                        ${algorithmDecision}<br>
                        <em>Days until deadline: ${daysUntilDeadline} | Batch distribution: ${Array.from(batches).join(', ')}</em>
                    </div>
                `;
            });
            
            analysisDiv.innerHTML = analysisHtml;
        }

        function displayBatchSummary(results) {
            const summaryDiv = document.getElementById('batchSummary');
            summaryDiv.innerHTML = '';
            
            // Group by part number
            const parts = {};
            results.forEach(row => {
                const partNumber = row[0];
                if (!parts[partNumber]) {
                    parts[partNumber] = [];
                }
                parts[partNumber].push(row);
            });
            
            let summaryHtml = '';
            Object.keys(parts).forEach(partNumber => {
                const operations = parts[partNumber];
                const orderQty = operations[0][1];
                const priority = operations[0][2];
                
                // Count unique batches
                const batches = new Set(operations.map(op => op[3]));
                const numBatches = batches.size;
                const avgBatchSize = Math.round(orderQty / numBatches);
                
                // Calculate efficiency metrics
                const efficiency = priority === 'Urgent' ? 'Maximum' : 
                                 priority === 'High' ? 'High' : 
                                 priority === 'Normal' ? 'Standard' : 'Efficient';
                
                summaryHtml += `
                    <div class="batch-info">
                        <strong>${partNumber}:</strong> ${orderQty} pieces ‚Üí ${numBatches} batches (avg ${avgBatchSize} pieces)<br>
                        <strong>Priority:</strong> ${priority} | <strong>Efficiency:</strong> ${efficiency} | <strong>Batches:</strong> ${Array.from(batches).join(', ')}
                    </div>
                `;
            });
            
            summaryDiv.innerHTML = summaryHtml;
        }
    </script>
</body>
</html>
